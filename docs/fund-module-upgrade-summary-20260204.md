# AlphaFunds 核心架构升级与板块归因开发进展

## 📅 更新日期
2026-02-04

## 🎯 阶段目标
将 AlphaFunds 从基础的“数据列表工具”升级为具有**板块归因、历史复盘、自动化运维**能力的专业投资分析终端。

---

## ✅ 已完成功能 (Milestones)

### 1. **深度板块归因 (Sector/Industry Attribution)** 📊
*   **行业标准**: 接入 **申万 (Shenwan) 2021** 行业分类标准，建立 `stock_metadata` 核心映射库。
*   **层级结构**: 支持 **Level 1 (大类)** 与 **Level 2 (细分赛道)** 的双层穿透分析。
*   **二级钻取 (Drill-down)**: 前端实现 L2 动态展开功能，点击大类行业可实时查看其内部细分板块的驱动力。
*   **可视化**: 采用金融终端风格的红绿对比迷你条形图，直观展示各板块对净值的 `Impact` (贡献度) 和 `Weight` (暴露权重)。

### 2. **全自动历史复盘系统 (2A Automation)** ⚙️
*   **闭环流程**: 实现了“收盘快照 -> 深夜对账 -> 偏差打分”的完整闭环。
*   **自动化引擎**: 新增 `run_funds.py` 独立后台进程，通过 `schedule` 实现精准定时任务：
    *   **15:05**: 自动执行全量估值快照（Snapshot）。
    *   **22:30**: 自动执行官方净值对账（Reconcile）。
    *   **01:00**: 自动执行行业与元数据每日同步。
*   **持久化归因**: 历史记录不仅保存净值，还通过 `frozen_sector_attribution` 字段持久化了每日板块贡献快照，支持事后深度溯源。

### 3. **系统架构解耦 (System Architecture)** 🏗️
*   **独立运行**: 基金系统与黄金情报系统在逻辑与进程上实现解耦。
*   **容器化升级**: `docker-compose.yml` 新增 `funds_worker` 节点，两套系统独立部署与维护。

---

## ⏸️ 待讨论与后续规划 (Pending)

### 1. **“影子持仓”动态回归分析 (2B)** 🕵️
*   **挑战**: 季报持仓存在 1-4 个月的滞后，高换手率基金的实时估值偏差较大。
*   **方案**: 引入回归分析模型，根据基金净值曲线与行业指数的相关性，动态修正“影子权重”。

### 2. **业绩分析深度优化** 📉
*   **交易费率归因**: 计提每日管理费损耗，消除复盘时的系统性误差。
*   **时间维度聚合**: 实现“周度/月度/季度”的板块贡献聚合视图（从截面分析转向时序分析）。
*   **超额收益 (Alpha) 归因**: 引入 Benchmark (如沪深300/中证500) 进行 Brinson 模型分析，区分“选股能力”与“配置能力”。

---

## 📁 核心改动文件

### 后端核心
*   **`src/alphasignal/core/fund_engine.py`**: 核心计算逻辑升级，增加 L1/L2 行业聚合与批量处理。
*   **`src/alphasignal/core/database.py`**: 扩展 `stock_metadata` 及 `fund_valuation_archive` 表结构。
*   **`run_funds.py`**: 新增基金自动化调度入口。
*   **`scripts/sync_stock_industries.py`**: 申万行业数据同步脚本。

### 前端 UI
*   **`web/components/SectorAttribution.tsx`**: 板块归因可视化组件（支持钻取）。
*   **`web/app/[locale]/funds/page.tsx`**: 集成 L2 归因视图与历史复盘详情。

---

## 📝 总结
通过本次升级，AlphaFunds 不仅解决了“今天谁在涨”的问题，更通过**板块归因**和**自动化复盘**解决了“为什么涨”以及“预测得准不准”的问题，系统正式进入**信用积累期**。
